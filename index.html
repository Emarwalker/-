<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#10b981" />
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏¢‡∏≤‡∏¢‡∏´‡∏ô‡∏∏‡πà‡∏¢ ‚Äî ‡∏™‡∏±‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <style>
    :root{
      --brand:#10b981;
      --brand2:#059669;
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --danger:#ef4444;
      --shadow: 0 10px 28px rgba(2,8,23,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Noto Sans Thai',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--ink);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:var(--brand2); text-decoration:none}
    .app{max-width:560px; margin:0 auto; padding-bottom:92px;}
    
    /* TOPBAR ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:rgba(246,247,251,.95);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid rgba(229,231,235,.9);
      padding:10px 14px;
    }
    .brandRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .titleWrap{min-width:0}
    .title{font-weight:900; font-size:18px; line-height:1.15; margin:0}
    .subtitle{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.2}
    
    .chipBtn{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      box-shadow:0 6px 14px rgba(2,8,23,.05);
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
    }
    .chipDot{width:10px; height:10px; border-radius:999px; background:var(--brand)}
    
    /* Address Bar (New) */
    .addrBar{
      margin-top:10px;
      background:#fff;
      border:1px solid var(--brand);
      border-radius:14px;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(16,185,129,.1);
    }
    .addrIcon{font-size:18px;}
    .addrInfo{flex:1; min-width:0;}
    .addrLabel{font-size:11px; color:var(--muted); font-weight:700; margin:0 0 2px;}
    .addrVal{font-size:13px; font-weight:900; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--brand2);}
    .addrEdit{font-size:12px; font-weight:800; color:var(--brand); white-space:nowrap;}

    .searchRow{margin-top:10px; display:flex; gap:10px;}
    .search{
      flex:1;
      border:1px solid var(--line);
      background:#fff;
      padding:12px 12px;
      border-radius:14px;
      font-size:15px;
      outline:none;
    }
    .clearBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
    }

    /* QR Card */
    .qrCard{
      margin:12px 14px 0;
      background:linear-gradient(180deg,#ffffff, #fbfffd);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .qrImg{
      width:92px; height:92px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      object-fit:contain;
      flex:0 0 auto;
    }
    .qrText{min-width:0}
    .qrTitle{font-weight:900; margin:0; font-size:15px; line-height:1.2}
    .qrDesc{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.2}
    .qrLink{display:inline-block; margin-top:8px; font-weight:900; font-size:13px}

    /* Category chips */
    .chips{
      margin:12px 14px 0;
      display:flex; gap:8px;
      overflow:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling:touch;
    }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(2,8,23,.05);
      flex:0 0 auto;
    }
    .chip.active{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color:#064e3b;
    }

    /* Menu list */
    .section{ margin:10px 14px 0; }
    .secHead{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:10px; margin:12px 2px 10px;
    }
    .secTitle{font-weight:900; font-size:16px; margin:0}
    .secDesc{font-size:12px; color:var(--muted); margin:0}
    .list{display:flex; flex-direction:column; gap:10px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px;
      box-shadow:0 10px 24px rgba(2,8,23,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .info{min-width:0}
    .nameRow{display:flex; align-items:center; gap:8px; min-width:0}
    .name{
      font-weight:900; font-size:15px; line-height:1.2; margin:0;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:290px;
    }
    .hot{
      font-size:11px; font-weight:900; color:#991b1b; background:#fee2e2;
      border:1px solid #fecaca; padding:3px 8px; border-radius:999px; flex:0 0 auto;
    }
    .metaRow{
      margin-top:6px; display:flex; align-items:center; gap:10px;
      color:var(--muted); font-size:12px; font-weight:700;
    }
    .price{ font-weight:1000; color:#065f46; font-size:16px; margin-left:auto; }
    .actions{display:flex; align-items:center; gap:8px;}
    .miniQty{
      min-width:34px; text-align:center; font-weight:1000; font-size:14px;
      color:#064e3b; background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.25);
      padding:8px 10px; border-radius:14px; display:none;
    }
    .btn{
      border:none; background:var(--brand); color:#fff; font-weight:1000; font-size:14px;
      padding:10px 12px; border-radius:14px; cursor:pointer;
      box-shadow:0 12px 22px rgba(16,185,129,.25);
    }
    .btn:active{transform:scale(.98)}
    .btnIcon{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      font-size:18px; border-radius:14px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }
    .btnIcon:active{transform:scale(.98)}

    /* Bottom bar */
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:#fff; border-top:1px solid var(--line);
      box-shadow:0 -10px 26px rgba(2,8,23,.08);
    }
    .bottomInner{max-width:560px; margin:0 auto; display:flex; gap:10px; align-items:center;}
    .cartBtn{
      flex:1; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-radius:16px; padding:12px 14px;
      border:1px solid rgba(16,185,129,.30); background:rgba(16,185,129,.10);
      cursor:pointer; font-weight:1000;
    }
    .cartLeft{display:flex; align-items:center; gap:10px;}
    .badge{
      background:var(--brand2); color:#fff; border-radius:999px;
      padding:4px 10px; font-size:12px; font-weight:1000;
    }
    .cartRight{font-weight:1000; color:#064e3b}
    .sendBtn{
      border:none; background:var(--brand); color:#fff; font-weight:1000;
      border-radius:16px; padding:12px 14px; cursor:pointer; min-width:108px;
      box-shadow:0 12px 22px rgba(16,185,129,.25);
    }

    /* Modal / sheet */
    .overlay{
      position:fixed; inset:0; background:rgba(2,8,23,.50);
      z-index:40; display:none;
    }
    .sheet{
      position:fixed; left:0; right:0; bottom:-100%; z-index:50;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:0 -20px 50px rgba(2,8,23,.25);
      max-width:560px; margin:0 auto; transition:bottom .22s ease;
      display:flex; flex-direction:column; max-height:84vh;
    }
    .sheet.show{bottom:0}
    .sheetHead{
      padding:10px 14px 8px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .grab{width:44px; height:5px; border-radius:999px; background:#e5e7eb; margin:6px auto 0}
    .sheetTitle{font-weight:1000; font-size:16px; margin:0}
    .xBtn{
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:10px 12px; font-weight:1000; cursor:pointer;
    }
    .sheetBody{padding:12px 14px; overflow:auto;}
    .row{
      border:1px solid var(--line); border-radius:18px; padding:12px; margin:0 0 10px; background:#fff;
    }
    .rowTop{display:flex; justify-content:space-between; gap:10px;}
    .rowName{font-weight:1000; margin:0; font-size:14px; line-height:1.25}
    .rowOpt{margin:6px 0 0; color:var(--muted); font-size:12px; font-weight:700; line-height:1.25}
    .rowNote{margin:6px 0 0; color:#475569; font-size:12px; font-weight:700}
    .qtyCtrl{display:flex; align-items:center; gap:8px;}
    .qtyBtn{
      width:38px; height:38px; border-radius:14px; border:1px solid var(--line);
      background:#fff; font-weight:1000; font-size:16px; cursor:pointer;
    }
    .qtyBox{
      min-width:46px; text-align:center; font-weight:1000; padding:8px 10px;
      border-radius:14px; background:#f8fafc; border:1px solid var(--line);
    }
    .delBtn{
      border:1px solid #fecaca; color:#991b1b; background:#fff5f5;
      border-radius:14px; padding:10px 12px; font-weight:1000;
      cursor:pointer; margin-left:8px;
    }
    .sheetFoot{
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      border-top:1px solid var(--line); display:flex; align-items:center; gap:10px; background:#fff;
    }
    .totalBox{
      flex:1; border-radius:16px; padding:10px 12px;
      background:#f8fafc; border:1px solid var(--line);
      font-weight:1000; color:#064e3b;
    }
    .primaryBig{
      border:none; background:var(--brand); color:#fff;
      font-weight:1000; border-radius:16px; padding:12px 14px; cursor:pointer;
      box-shadow:0 12px 22px rgba(16,185,129,.25); min-width:120px;
    }

    /* Modal general */
    .modal{
      position:fixed; inset:0; z-index:60; display:none;
      align-items:flex-end; justify-content:center;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .modalCard{
      width:100%; max-width:560px; background:#fff; border-radius:22px;
      box-shadow:0 20px 60px rgba(2,8,23,.35); border:1px solid var(--line); overflow:hidden;
    }
    .mHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .mTitle{margin:0; font-weight:1000; font-size:16px; line-height:1.2}
    .mBody{padding:12px 14px; max-height:64vh; overflow:auto;}
    .group{margin:0 0 12px}
    .gTitle{font-weight:1000; font-size:13px; margin:0 0 8px}
    .gHint{font-size:12px; color:var(--muted); font-weight:700}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
    .opt{
      border:1px solid var(--line); border-radius:14px; padding:10px 10px;
      background:#fff; font-weight:900; font-size:13px; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .opt small{color:var(--muted); font-weight:900}
    .opt.active{
      border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.12); color:#064e3b;
    }
    .qtyLine{display:flex; align-items:center; gap:10px;}
    .qtyLine input{
      width:76px; text-align:center; padding:10px 10px; border-radius:14px;
      border:1px solid var(--line); font-size:14px; font-weight:1000; background:#fff; outline:none;
    }
    textarea{
      width:100%; border:1px solid var(--line); border-radius:14px;
      padding:10px 10px; font-size:14px; font-weight:700; outline:none; resize:none;
      font-family:inherit;
    }
    .mFoot{
      padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:10px; align-items:center;
    }
    .ghost{
      flex:1; border:1px solid var(--line); background:#fff; border-radius:16px;
      padding:12px 14px; font-weight:1000; cursor:pointer;
    }
    .ok{
      flex:1; border:none; background:var(--brand); color:#fff; border-radius:16px;
      padding:12px 14px; font-weight:1000; cursor:pointer;
      box-shadow:0 12px 22px rgba(16,185,129,.25);
    }
    .subTotal{font-weight:1000; color:#064e3b}

    /* MAP SPECIFIC */
    .mapModal{
      position:fixed; inset:0; z-index:70; background:#fff;
      display:none; flex-direction:column;
    }
    .mapHead{
      padding:12px 14px; border-bottom:1px solid var(--line); background:#fff;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.05); z-index:10;
    }
    .mapContainer{
      flex:1; position:relative; background:#eee;
    }
    #map{ width:100%; height:100%; }
    .mapFooter{
      padding:14px; background:#fff; border-top:1px solid var(--line);
      box-shadow:0 -4px 12px rgba(0,0,0,0.05); z-index:10;
    }
    .gpsBtn{
      position:absolute; bottom:20px; right:14px; z-index:999;
      background:#fff; border:2px solid var(--brand); width:48px; height:48px;
      border-radius:50%; font-size:24px; display:flex; align-items:center;
      justify-content:center; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }
    .gpsBtn:active{ transform:scale(0.95); }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:88px;
      z-index:80; background:#0f172a; color:#fff; border-radius:999px;
      padding:10px 14px; font-weight:900; font-size:13px;
      box-shadow:0 16px 36px rgba(2,8,23,.35); display:none;
      max-width:90vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brandRow">
        <div class="titleWrap">
          <h1 class="title">‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏¢‡∏≤‡∏¢‡∏´‡∏ô‡∏∏‡πà‡∏¢</h1>
          <p class="subtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π ‚Üí ‡∏™‡πà‡∏á LINE OA</p>
        </div>
        <button class="chipBtn" type="button" id="btnOpenCartTop">
          <span class="chipDot"></span>
          <span>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
          <span class="badge" id="topCount">0</span>
        </button>
      </div>

      <div class="addrBar" id="btnAddress">
        <span class="addrIcon">üìç</span>
        <div class="addrInfo">
          <p class="addrLabel">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà</p>
          <p class="addrVal" id="addrText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</p>
        </div>
        <div class="addrEdit">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ></div>
      </div>

      <div class="searchRow">
        <input id="search" class="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö / ‡∏Å‡∏∏‡πâ‡∏á" />
        <button class="clearBtn" type="button" id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <div class="qrCard">
      <img class="qrImg" src="S_gainfriends_2dbarcodes_GW.png" alt="LINE QR" loading="lazy" decoding="async">
      <div class="qrText">
        <p class="qrTitle">‡∏™‡∏±‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE</p>
        <p class="qrDesc">‡πÅ‡∏≠‡∏î LINE OA ‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
        <a class="qrLink" href="https://line.me/R/ti/p/@218sgmwj" target="_blank" rel="noopener">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô @218sgmwj</a>
      </div>
    </div>

    <div class="chips" id="chips"></div>

    <div class="section" id="menu"></div>

    <div style="height:16px"></div>
  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <button class="cartBtn" type="button" id="btnOpenCart">
        <span class="cartLeft">
          <span class="badge" id="cartCount">0</span>
          <span>‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
        </span>
        <span class="cartRight" id="cartTotal">0‡∏ø</span>
      </button>
      <button class="sendBtn" type="button" id="btnSend">‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="grab"></div>
    <div class="sheetHead">
      <p class="sheetTitle">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
      <button class="xBtn" type="button" id="btnCloseSheet">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
    <div class="sheetFoot">
      <div class="totalBox" id="sheetTotal">‡∏£‡∏ß‡∏° 0‡∏ø</div>
      <button class="primaryBig" type="button" id="btnSheetSend">‡∏™‡πà‡∏á LINE</button>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="mHead">
        <p class="mTitle" id="mTitle">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π</p>
        <button class="xBtn" type="button" id="btnCloseModal">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="mBody">
        <div class="group">
          <p class="gTitle">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
          <div class="qtyLine">
            <button class="qtyBtn" type="button" id="mDec">‚àí</button>
            <input type="text" id="mQty" value="1" inputmode="numeric" />
            <button class="qtyBtn" type="button" id="mInc">+</button>
            <span class="gHint" id="mBasePrice"></span>
          </div>
        </div>
        <div class="group">
          <p class="gTitle">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î <span style="color:var(--danger)">(‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</span></p>
          <div class="grid" id="mSpice"></div>
        </div>
        <div class="group">
          <p class="gTitle">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì <span style="color:var(--danger)">(‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</span></p>
          <div class="grid" id="mPortion"></div>
        </div>
        <div class="group hidden" id="mProteinWrap">
          <p class="gTitle">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (0‡∏ø)</p>
          <div class="grid" id="mProtein"></div>
        </div>
        <div class="group">
          <p class="gTitle">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (+10‡∏ø/‡∏≠‡∏¢‡πà‡∏≤‡∏á)</p>
          <div class="grid" id="mAddons"></div>
        </div>
        <div class="group">
          <p class="gTitle">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</p>
          <textarea id="mNote" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏á‡∏ä‡∏π‡∏£‡∏™ / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤"></textarea>
        </div>
        <div class="group">
          <p class="gTitle">‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢</p>
          <div class="subTotal" id="mSubtotal">0‡∏ø</div>
        </div>
      </div>
      <div class="mFoot">
        <button class="ghost" type="button" id="btnCopyDraft">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        <button class="ok" type="button" id="btnAddToCart">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
      </div>
    </div>
  </div>

  <div class="mapModal" id="mapModal">
    <div class="mapHead">
      <p class="mTitle">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
      <button class="xBtn" type="button" id="btnCloseMap">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="mapContainer">
      <div id="map"></div>
      <button class="gpsBtn" type="button" id="btnGPS" aria-label="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">üéØ</button>
    </div>
    <div class="mapFooter">
      <div class="group">
        <p class="gTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï)</p>
        <textarea id="mapDetail" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 99/9 ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô... ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏£‡∏±‡πâ‡∏ß‡∏™‡∏µ‡∏ü‡πâ‡∏≤"></textarea>
      </div>
      <button class="primaryBig" style="width:100%" type="button" id="btnConfirmMap">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
/* ================= ES5 utilities ================= */
function $(id){ return document.getElementById(id); }
function trim(s){ return String(s||'').replace(/^\s+|\s+$/g,''); }
function toInt(v, d){
  var n = parseInt(v,10);
  if(isNaN(n)) return d;
  return n;
}
function escapeText(s){
  return String(s||'').replace(/[\r\n]+/g,' ').replace(/\s+/g,' ').replace(/^\s+|\s+$/g,'');
}
function showToast(msg){
  var t = $('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(showToast._tm);
  showToast._tm = setTimeout(function(){ t.style.display='none'; }, 1500);
}

/* ================= CONFIG ================= */
var OA_ID = '@218sgmwj';
var ADDON_PRICE = 10;
var SPICES = ['‡πÄ‡∏ú‡πá‡∏î','‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á','‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢','‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î'];
var PORTIONS = [{label:'‡∏õ‡∏Å‡∏ï‡∏¥', add:0}, {label:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', add:10}];
var ADDONS = ['‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß','‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß','‡∏Å‡∏∏‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á','‡∏´‡∏°‡∏π‡∏¢‡∏≠','‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤'];
var ENABLE_EGGS = true;

var CATEGORIES = [
  { id:'kaprao', title:'‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤', desc:'‡πÄ‡∏ú‡πá‡∏î‡∏´‡∏≠‡∏°‡πÉ‡∏ö‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤', items:[
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö', price:45, hot:true },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÑ‡∏Å‡πà', price:40, hot:true },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö', price:55, hot:true },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏Å‡πà', price:40 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô', price:45 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡πâ‡∏á', price:60 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏¢‡∏≠', price:45 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏Å‡∏∏‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á', price:45 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏õ‡∏•‡∏≤‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', price:45 },
    { name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤', price:60 }
  ]},
  { id:'garlic', title:'‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', desc:'‡∏´‡∏≠‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', items:[
    { name:'‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', price:40, hot:true },
    { name:'‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', price:45 },
    { name:'‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', price:55, hot:true },
    { name:'‡∏Å‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', price:60 }
  ]},
  { id:'curry', title:'‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á', desc:'‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏ô', items:[
    { name:'‡∏ú‡∏±‡∏î‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏Ç‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏ä‡∏¥‡πâ‡∏ô', price:50, hot:true },
    { name:'‡∏ú‡∏±‡∏î‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡πÑ‡∏Å‡πà', price:45 },
    { name:'‡∏ú‡∏±‡∏î‡∏û‡∏£‡∏¥‡∏Å‡∏´‡∏¢‡∏ß‡∏Å‡πÑ‡∏Å‡πà/‡∏´‡∏°‡∏π', price:45, proteins:['‡πÑ‡∏Å‡πà','‡∏´‡∏°‡∏π'] },
    { name:'‡∏ú‡∏±‡∏î‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏ñ‡∏±‡πà‡∏ß‡πÉ‡∏™‡πà‡πÑ‡∏Å‡πà', price:45 },
    { name:'‡∏ú‡∏±‡∏î‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏Å‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö', price:65 }
  ]},
  { id:'special', title:'‡∏û‡∏¥‡πÄ‡∏®‡∏©', desc:'‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏¥‡πÄ‡∏®‡∏©', items:[
    { name:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö (1 ‡∏ü‡∏≠‡∏á)', price:35 },
    { name:'‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö (2 ‡∏ü‡∏≠‡∏á)', price:45, hot:true },
    { name:'‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏≠‡∏î‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤', price:65 }
  ]}
];

/* ================= Format THB ================= */
var hasIntl = typeof Intl!=='undefined' && Intl && typeof Intl.NumberFormat==='function';
var THB = hasIntl ? new Intl.NumberFormat('th-TH') : null;
function fmt(n){
  if(THB){ try{ return THB.format(n); }catch(e){} }
  var s = String(Math.round(n));
  var out='', i=s.length, c=0;
  while(i--){ out=s.charAt(i)+out; c++; if(c%3===0 && i>0) out=','+out; }
  return out;
}
function thb(n){ return fmt(n)+'‡∏ø'; }

/* ================= Cart & Location ================= */
var STORAGE_KEY='yai-nui-cart-lite-v2'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô key ‡πÄ‡∏û‡∏∑‡πà‡∏≠ reset
var cart=[]; 
var address = { lat:null, lng:null, detail:'' };

function makeKey(o){
  var a = o.addons && o.addons.length ? o.addons.slice().sort().join('+') : '';
  return [o.name,o.spice,o.portion,o.protein||'',a,o.note||''].join('||');
}
function unitPrice(it){
  return (it.base||0) + (it.portionAdd||0) + ((it.addons?it.addons.length:0)*ADDON_PRICE);
}
function totals(){
  var c=0,t=0;
  for(var i=0;i<cart.length;i++){
    c += cart[i].qty;
    t += unitPrice(cart[i])*cart[i].qty;
  }
  return {count:c,total:t};
}
function saveCart(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }catch(e){}
}
function loadCart(){
  try{
    var raw = localStorage.getItem(STORAGE_KEY);
    cart = raw ? (JSON.parse(raw)||[]) : [];
  }catch(e){ cart=[]; }
}
function addToCart(o){
  o.id = makeKey(o);
  for(var i=0;i<cart.length;i++){
    if(cart[i].id===o.id){
      cart[i].qty += o.qty;
      saveCart(); refreshAll();
      return;
    }
  }
  cart.push(o);
  saveCart(); refreshAll();
}
function setQty(i, q){
  q = toInt(q,1); if(q<1) q=1;
  cart[i].qty = q;
  saveCart(); refreshAll();
}
function delItem(i){
  cart.splice(i,1);
  saveCart(); refreshAll();
}

/* ================= Map Logic ================= */
var mapObj = null;
var markerObj = null;
// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏Å‡∏ó‡∏° (Rangsit)
var defLat = 13.98, defLng = 100.61;

function initMap(){
  if(mapObj) return; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥

  // ‡πÉ‡∏ä‡πâ OpenStreetMap Tile
  mapObj = L.map('map').setView([defLat, defLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(mapObj);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
  markerObj = L.marker([defLat, defLng], {draggable:true}).addTo(mapObj);

  markerObj.on('dragend', function(e){
    var pos = markerObj.getLatLng();
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  });
  
  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏°‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î
  mapObj.on('click', function(e){
    markerObj.setLatLng(e.latlng);
  });
}

function openMap(){
  $('mapModal').style.display = 'flex';
  
  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å invalidateSize ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏°‡∏û render ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  setTimeout(function(){
    initMap();
    mapObj.invalidateSize();
    if(address.lat){
      var latlng = [address.lat, address.lng];
      mapObj.setView(latlng, 16);
      markerObj.setLatLng(latlng);
      $('mapDetail').value = address.detail || '';
    } else {
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ GPS ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      getLocation();
    }
  }, 100);
}

function getLocation() {
  if (navigator.geolocation) {
    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...');
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      mapObj.setView([lat, lng], 17);
      markerObj.setLatLng([lat, lng]);
      showToast('‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
    }, function(err){
      showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
    });
  } else {
    showToast('Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
  }
}

function confirmLocation(){
  var pos = markerObj.getLatLng();
  var det = trim($('mapDetail').value);
  
  address.lat = pos.lat.toFixed(6);
  address.lng = pos.lng.toFixed(6);
  address.detail = det;
  
  // Update UI Address Bar
  $('addrText').textContent = (det ? det.substring(0,20)+'...' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ('+address.lat+','+address.lng+')');
  $('addrText').style.color = '#0f172a';
  
  $('mapModal').style.display = 'none';
}

/* ================= LINE send ================= */
function openLineWith(text){
  var encoded = encodeURIComponent(text).replace(/%0A/g,'%0D%0A');
  var appUrl = 'line://oaMessage/' + OA_ID + '/?message=' + encoded;
  var webUrl = 'https://line.me/R/oaMessage/' + OA_ID + '/?message=' + encoded;

  var timer = setTimeout(function(){
    window.location.href = webUrl;
  }, 700);

  window.location.href = appUrl;
  window.addEventListener('pagehide', function(){ clearTimeout(timer); }, {once:true});
}

function buildOrderText(){
  var lines=[], grand=0;
  for(var i=0;i<cart.length;i++){
    var it=cart[i];
    var opt=[];
    opt.push(it.spice);
    opt.push(it.portion);
    if(it.protein) opt.push(it.protein);

    var addonTxt = it.addons && it.addons.length ? (' + ' + it.addons.join(' + ')) : '';
    var unit = unitPrice(it);
    grand += unit*it.qty;

    var noteTxt = it.note ? ('\n  ‚Ä¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ' + it.note) : '';
    lines.push((i+1)+') '+it.name+addonTxt+' ('+opt.join(', ')+') √ó'+it.qty+' ‚Äî '+thb(unit)+'/‡∏ó‡∏µ‡πà'+noteTxt);
  }
  lines.push('----------------');
  lines.push('‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: '+thb(grand));
  
  // Location Section
  lines.push('----------------');
  if(address.lat && address.lng){
    lines.push('üìç ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: ' + (address.detail || '‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏∏‡∏î'));
    lines.push('üó∫ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: https://www.google.com/maps/search/?api=1&query=' + address.lat + ',' + address.lng);
  } else {
    lines.push('üìç ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà: (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î)');
  }
  
  return lines.join('\n');
}

function sendOrder(){
  if(!cart.length){ showToast('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); return; }
  if(!address.lat){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'); openMap(); return; }
  
  var text = buildOrderText();
  openLineWith(text);
}

/* ================= UI Logic (Existing) ================= */
var state = { activeCat: CATEGORIES[0].id, query: '', cur: null, m: { qty:1, spice:'', portion:'', portionAdd:0, protein:'', addons:[], note:'' } };

function renderChips(){
  var chips = $('chips');
  var html='';
  for(var i=0;i<CATEGORIES.length;i++){
    var c=CATEGORIES[i];
    html += '<button class="chip'+(c.id===state.activeCat?' active':'')+'" data-cat="'+c.id+'" type="button">'+c.title+'</button>';
  }
  chips.innerHTML = html;
  chips.onclick = function(e){
    var t = e.target;
    var id = t && t.getAttribute ? t.getAttribute('data-cat') : null;
    if(id){ state.activeCat = id; renderChips(); renderMenu(); window.scrollTo(0,0); }
  };
}

function matchQuery(name){
  var q = state.query;
  if(!q) return true;
  return name.toLowerCase().indexOf(q) > -1;
}

function countMenuQty(menuName){
  var sum=0;
  for(var i=0;i<cart.length;i++){ if(cart[i].name===menuName) sum += cart[i].qty; }
  return sum;
}

function renderMenu(){
  var box = $('menu');
  var cat=null;
  for(var i=0;i<CATEGORIES.length;i++){ if(CATEGORIES[i].id===state.activeCat){ cat=CATEGORIES[i]; break; } }
  if(!cat){ box.innerHTML=''; return; }

  var listHtml='', shown=0;
  for(var j=0;j<cat.items.length;j++){
    var it = cat.items[j];
    if(!matchQuery(it.name)) continue;
    shown++;
    var q = countMenuQty(it.name);
    var mini = q>0 ? ' style="display:block"' : '';
    var hot = it.hot ? '<span class="hot">Hot</span>' : '';
    listHtml += '<div class="card" data-name="'+it.name+'" data-price="'+it.price+'" data-proteins="'+(it.proteins?it.proteins.join(','):'')+'">'
      + '<div class="info"><div class="nameRow"><p class="name">'+it.name+'</p>'+hot+'</div><div class="metaRow"><span>‡πÄ‡∏£‡∏¥‡πà‡∏°</span><span class="price">'+thb(it.price)+'</span></div></div>'
      + '<div class="actions"><div class="miniQty" data-mini="'+it.name+'"'+mini+'>'+q+'</div><button class="btnIcon" type="button" data-act="quick" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°">+</button><button class="btn" type="button" data-act="order">‡∏™‡∏±‡πà‡∏á</button></div></div>';
  }
  var head = '<div class="secHead"><div><p class="secTitle">'+cat.title+'</p><p class="secDesc">'+(cat.desc||'')+'</p></div><div class="secDesc">'+(state.query?('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‚Äú'+escapeText(state.query)+'‚Äù'):'')+'</div></div>';
  if(shown===0){ box.innerHTML = head + '<div class="list"><div class="card"><div class="info"><p class="name">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π</p></div></div></div>'; return; }
  box.innerHTML = head + '<div class="list">'+listHtml+'</div>';

  box.onclick = function(e){
    var t = e.target; if(!t || !t.getAttribute) return;
    var act = t.getAttribute('data-act'); if(!act) return;
    var card = t; while(card && card !== box && !(card.className && String(card.className).indexOf('card')>-1)){ card = card.parentNode; }
    if(!card || card===box) return;
    var name = card.getAttribute('data-name');
    var price = toInt(card.getAttribute('data-price'),0);
    var proteins = trim(card.getAttribute('data-proteins')||'');
    openOptions({name:name, price:price, proteins:proteins?proteins.split(','):[]});
  };
}

function openOptions(item){
  state.cur = item;
  state.m = { qty:1, spice:'', portion:'', portionAdd:0, protein:item.proteins&&item.proteins.length?item.proteins[0]:'', addons:[], note:'' };
  $('mTitle').textContent = '‡∏™‡∏±‡πà‡∏á ‚Äî ' + item.name;
  $('mQty').value = '1';
  $('mBasePrice').textContent = '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ' + thb(item.price);
  renderOptions(); calcModalSubtotal();
  $('overlay').style.display='block'; $('modal').style.display='flex';
}
function closeOptions(){ $('modal').style.display='none'; if(!$('sheet').classList.contains('show')) $('overlay').style.display='none'; }

function renderOptions(){
  var sHtml=''; for(var i=0;i<SPICES.length;i++){ sHtml+='<button class="opt'+(state.m.spice===SPICES[i]?' active':'')+'" type="button" data-spice="'+SPICES[i]+'">'+SPICES[i]+'</button>'; } $('mSpice').innerHTML = sHtml;
  var pHtml=''; for(var j=0;j<PORTIONS.length;j++){ pHtml+='<button class="opt'+(state.m.portion===PORTIONS[j].label?' active':'')+'" type="button" data-portion="'+PORTIONS[j].label+'" data-add="'+PORTIONS[j].add+'">'+PORTIONS[j].label+(PORTIONS[j].add?('<small>+'+PORTIONS[j].add+'‡∏ø</small>'):'')+'</button>'; } $('mPortion').innerHTML = pHtml;
  var wrap=$('mProteinWrap'); var prot=state.cur.proteins||[]; 
  if(prot.length){ wrap.className='group'; var prHtml=''; for(var k=0;k<prot.length;k++){ prHtml+='<button class="opt'+(state.m.protein===prot[k]?' active':'')+'" type="button" data-protein="'+prot[k]+'">'+prot[k]+'</button>'; } $('mProtein').innerHTML=prHtml; }else{ wrap.className='group hidden'; $('mProtein').innerHTML=''; }
  var addons=[]; for(var a=0;a<ADDONS.length;a++){ if(ENABLE_EGGS||ADDONS[a].indexOf('‡πÑ‡∏Ç‡πà')===-1) addons.push(ADDONS[a]); }
  var aHtml=''; for(var b=0;b<addons.length;b++){ var on=state.m.addons.indexOf(addons[b])>-1; aHtml+='<button class="opt'+(on?' active':'')+'" type="button" data-addon="'+addons[b]+'">'+addons[b]+'<small>+10‡∏ø</small></button>'; } $('mAddons').innerHTML=aHtml;
  $('mNote').value = state.m.note||'';

  $('mSpice').onclick = function(e){ var v=e.target.getAttribute('data-spice'); if(v){state.m.spice=v; renderOptions(); calcModalSubtotal();} };
  $('mPortion').onclick = function(e){ var v=e.target.getAttribute('data-portion'); if(v){state.m.portion=v; state.m.portionAdd=toInt(e.target.getAttribute('data-add'),0); renderOptions(); calcModalSubtotal();} };
  $('mProtein').onclick = function(e){ var v=e.target.getAttribute('data-protein'); if(v){state.m.protein=v; renderOptions(); calcModalSubtotal();} };
  $('mAddons').onclick = function(e){ var v=e.target.getAttribute('data-addon'); if(v){var idx=state.m.addons.indexOf(v); if(idx>-1)state.m.addons.splice(idx,1); else state.m.addons.push(v); renderOptions(); calcModalSubtotal();} };
  $('mNote').oninput = function(){ state.m.note=trim($('mNote').value); };
}
function calcModalSubtotal(){
  var qty=toInt($('mQty').value,1); if(qty<1)qty=1;
  var unit=state.cur.price+(state.m.portionAdd||0)+(state.m.addons.length*ADDON_PRICE);
  $('mSubtotal').textContent=thb(unit*qty)+'  (‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà '+thb(unit)+')';
}
function addCurrentToCart(){
  var qty=toInt($('mQty').value,1); if(qty<1)qty=1;
  state.m.note=trim($('mNote').value);
  if(!state.m.spice){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î'); return; }
  if(!state.m.portion){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì'); return; }
  addToCart({ name:state.cur.name, base:state.cur.price, spice:state.m.spice, portion:state.m.portion, portionAdd:state.m.portionAdd||0, protein:state.m.protein||'', addons:state.m.addons.slice(), note:state.m.note||'', qty:qty });
  showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: '+state.cur.name+' √ó'+qty); closeOptions();
}

/* ================= Cart Sheet & Events ================= */
function openSheet(){ $('overlay').style.display='block'; $('sheet').classList.add('show'); renderSheet(); }
function closeSheet(){ $('sheet').classList.remove('show'); setTimeout(function(){ if($('modal').style.display!=='flex') $('overlay').style.display='none'; },220); }
function renderSheet(){
  var body=$('sheetBody'); if(!cart.length){ body.innerHTML='<div class="row"><p class="rowName">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p></div>'; $('sheetTotal').textContent='‡∏£‡∏ß‡∏° 0‡∏ø'; return; }
  var html=''; for(var i=0;i<cart.length;i++){ var it=cart[i]; var opt=[it.spice,it.portion]; if(it.protein)opt.push(it.protein); var unit=unitPrice(it);
    html+='<div class="row"><div class="rowTop"><div style="min-width:0"><p class="rowName">'+it.name+(it.addons.length?(' + '+it.addons.join('+')):'')+'</p><div class="rowOpt">('+opt.join(', ')+') ‚Ä¢ '+thb(unit)+'/‡∏ó‡∏µ‡πà ‚Ä¢ ‡∏£‡∏ß‡∏° '+thb(unit*it.qty)+'</div>'+(it.note?('<div class="rowNote">‚Ä¢ '+it.note+'</div>'):'')+'</div><div style="text-align:right"><div class="qtyCtrl"><button class="qtyBtn" data-dec="'+i+'">‚àí</button><div class="qtyBox">'+it.qty+'</div><button class="qtyBtn" data-inc="'+i+'">+</button><button class="delBtn" data-del="'+i+'">‡∏•‡∏ö</button></div></div></div></div>';
  } body.innerHTML=html; $('sheetTotal').textContent='‡∏£‡∏ß‡∏° '+thb(totals().total);
  body.onclick=function(e){ var t=e.target; if(t.getAttribute('data-dec')!=null) setQty(toInt(t.getAttribute('data-dec')),cart[toInt(t.getAttribute('data-dec'))].qty-1); else if(t.getAttribute('data-inc')!=null) setQty(toInt(t.getAttribute('data-inc')),cart[toInt(t.getAttribute('data-inc'))].qty+1); else if(t.getAttribute('data-del')!=null) delItem(toInt(t.getAttribute('data-del'))); renderSheet(); };
}

function refreshAll(){
  var t=totals(); $('cartCount').textContent=t.count; $('topCount').textContent=t.count; $('cartTotal').textContent=thb(t.total);
  var minis=document.querySelectorAll('[data-mini]');
  for(var i=0;i<minis.length;i++){ var q=countMenuQty(minis[i].getAttribute('data-mini')); minis[i].textContent=q; minis[i].style.display=q>0?'block':'none'; }
}

$('btnOpenCart').onclick=openSheet; $('btnOpenCartTop').onclick=openSheet; $('btnCloseSheet').onclick=closeSheet; $('btnSheetSend').onclick=function(){closeSheet(); sendOrder();}; $('btnSend').onclick=sendOrder;
$('overlay').onclick=function(){ if($('modal').style.display==='flex'){closeOptions(); return;} if($('sheet').classList.contains('show'))closeSheet(); };
$('btnCloseModal').onclick=closeOptions; $('mDec').onclick=function(){$('mQty').value=Math.max(1,toInt($('mQty').value,1)-1);calcModalSubtotal();}; $('mInc').onclick=function(){$('mQty').value=toInt($('mQty').value,1)+1;calcModalSubtotal();}; $('mQty').oninput=calcModalSubtotal; $('btnAddToCart').onclick=addCurrentToCart;
$('search').oninput=function(){ state.query=trim($('search').value).toLowerCase(); renderMenu(); }; $('btnClear').onclick=function(){$('search').value='';state.query='';renderMenu();}; $('btnCopyDraft').onclick=function(){ showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'); };

// Map Events
$('btnAddress').onclick = openMap;
$('btnCloseMap').onclick = function(){ $('mapModal').style.display='none'; };
$('btnGPS').onclick = getLocation;
$('btnConfirmMap').onclick = confirmLocation;

loadCart(); renderChips(); renderMenu(); refreshAll();
</script>
</body>
</html>
